name: Check exercises

on:
  pull_request:

jobs:
  test-exercise:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Extract exercise number from branch name
        id: extract_ex
        run: |
          echo "Branch: $GITHUB_HEAD_REF"

          BRANCH_NAME="$GITHUB_HEAD_REF"
          EX_NUM="${BRANCH_NAME##*@}"

          if ! echo "$EX_NUM" | grep -Eq '^[0-9]+$'; then
            echo "Could not extract a numeric exercise number from branch name: $BRANCH_NAME"
            exit 1
          fi

          EX_NUM_PADDED=$(printf "%02d" "$EX_NUM")

          echo "EX_NUM=$EX_NUM" >> $GITHUB_ENV
          echo "EX_NUM_PADDED=$EX_NUM_PADDED" >> $GITHUB_ENV

          # Map exercise number to folder name (same mapping as run_exercise.sh)
          case "$EX_NUM_PADDED" in
            01) EX_NAME="ex01_sum" ;;
            02) EX_NAME="ex02_max_in_list" ;;
            03) EX_NAME="ex03_is_sorted" ;;
            04) EX_NAME="ex04_selection_sort" ;;
            05) EX_NAME="ex05_binary_search" ;;
            06) EX_NAME="ex06_two_sum_closest" ;;
            *)
              echo "Unsupported exercise number: $EX_NUM"
              exit 1
              ;;
          esac

          echo "EX_NAME=$EX_NAME" >> $GITHUB_ENV

          echo "Detected exercise number: $EX_NUM (padded: $EX_NUM_PADDED) for folder: $EX_NAME"

      - name: Install pytest
        run: |
          python -m pip install --upgrade pip
          python -m pip install pytest

      # NEW: static check to forbid certain helpers
      - name: Check for forbidden helpers
        run: |
          echo "Running static checks for $EX_NAME"
          python check_forbidden_api.py "$EX_NAME"

      - name: Run tests for this exercise
        run: |
          echo "Running tests for exercise: $EX_NUM_PADDED ($EX_NAME)"
          export PYTHONPATH=.
          pytest "tests/test_ex${EX_NUM_PADDED}.py"
